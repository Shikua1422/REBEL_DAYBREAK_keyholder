<script src="https://www.youtube.com/iframe_api"></script>
<script>
let ytPlayer;
let duration = 0;
let seeking = false;
let readyForPlayback = false;
let stableTimer = null;

const seekbar = document.getElementById("seekbar");
const cd = document.getElementById("cd");

/* 回線判定 */
function isLikelyWifi() {
  if (!navigator.connection) return false;
  return navigator.connection.type === "wifi"
    || navigator.connection.effectiveType === "4g";
}

function onYouTubeIframeAPIReady() {
  ytPlayer = new YT.Player('player', {
    videoId: 'HCoTcCMLRsM',
    playerVars: {
      playsinline: 1,
      controls: 0,
      rel: 0,
      modestbranding: 1,
      iv_load_policy: 3
    },
    events: {
      onReady,
      onStateChange
    }
  });
}

function onReady() {
  ytPlayer.setPlaybackQuality('small');
  ytPlayer.setVolume(0); // ★ 常に初期は無音
  duration = ytPlayer.getDuration();
  document.getElementById("duration").textContent = format(duration);
  updateLoop();
}

function play() {
  ytPlayer.setVolume(0); // ★ PLAY押下時も必ず無音
  ytPlayer.playVideo();
}

function pause() {
  ytPlayer.pauseVideo();
}

function onStateChange(e) {
  if (e.data === YT.PlayerState.PLAYING && !readyForPlayback) {
    ytPlayer.setVolume(0); // ★ PLAYING直後も即ミュート

    // 再生が1秒安定したら「本編開始」
    stableTimer = setTimeout(startMainPlayback, 1000);
  }

  if (e.data !== YT.PlayerState.PLAYING && stableTimer) {
    clearTimeout(stableTimer);
    stableTimer = null;
  }
}

function startMainPlayback() {
  if (readyForPlayback) return;
  readyForPlayback = true;

  // CD回転開始
  cd.style.animationPlayState = "running";

  // シーク解放
  seekbar.disabled = false;

  // 音量フェードイン
  let vol = 0;
  const fade = setInterval(() => {
    vol += 5;
    ytPlayer.setVolume(vol);
    if (vol >= 100) clearInterval(fade);
  }, 100);

  // 画質切替（ここで初めて）
  ytPlayer.setPlaybackQuality(
    isLikelyWifi() ? 'hd720' : 'small'
  );
}

/* シーク制御 */
seekbar.addEventListener("input", () => {
  if (!readyForPlayback) return;
  seeking = true;
});

seekbar.addEventListener("change", () => {
  if (!readyForPlayback) return;
  const target = (seekbar.value / 100) * duration;
  ytPlayer.seekTo(target, true);
  seeking = false;
});

/* 時間更新 */
function updateLoop() {
  if (
    ytPlayer &&
    ytPlayer.getCurrentTime &&
    readyForPlayback &&
    !seeking
  ) {
    const current = ytPlayer.getCurrentTime();
    seekbar.value = (current / duration) * 100;
    document.getElementById("current").textContent = format(current);
  }
  requestAnimationFrame(updateLoop);
}

function format(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60).toString().padStart(2, "0");
  return `${m}:${s}`;
}
</script>
